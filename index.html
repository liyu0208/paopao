<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Chat OS Ultra</title>
<!-- 引入库 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
/* === 全局核心样式 === */
body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; background: #f0f8ff; font-family: -apple-system, sans-serif; }
#app { height: 100%; width: 100%; position: relative; display: flex; flex-direction: column; }
.hidden-input { display: none !important; }
/* === 壁纸 === */
.wallpaper-bg {
background: url('https://images.unsplash.com/photo-1621256627040-39832205566d?q=80&w=1000&auto=format&fit=crop') no-repeat center center;
background-size: cover;
}
/* === 布局辅助 === */
.app-layout { display: flex; flex-direction: column; height: 100%; width: 100%; background-color: #f8fafc; }
/* === Header === */
.app-header {
flex-shrink: 0; padding-top: max(50px, env(safe-area-inset-top)); padding-bottom: 12px; height: auto;
display: flex; align-items: center; justify-content: space-between; padding-left: 16px; padding-right: 16px;
background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-bottom: 1px solid #e2e8f0; z-index: 50;
}
.app-content { flex: 1; overflow-y: auto; position: relative; padding-bottom: 20px; }
/* === 底部 Dock & Tab === */
.dock-wrapper { width: 100%; padding: 0 16px; display: flex; justify-content: center; margin-bottom: 20px; }
.dock-container { width: 100%; height: 90px; background: rgba(255, 255, 255, 0.45); backdrop-filter: blur(25px); border-radius: 35px; display: flex; justify-content: space-around; align-items: center; border: 1px solid rgba(255,255,255,0.6); box-shadow: 0 10px 40px rgba(100,149,237,0.25); }
.tab-bar { position: fixed; bottom: 0; left: 0; right: 0; height: 60px; background: rgba(255,255,255,0.95); border-top: 1px solid #e2e8f0; display: flex; align-items: center; padding-bottom: env(safe-area-inset-bottom); z-index: 50; }
.tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #94a3b8; font-size: 10px; gap: 4px; }
.tab-item.active { color: #3b82f6; }
/* === 组件样式 === */
.app-icon { width: 68px; height: 68px; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 30px; color: white; box-shadow: 0 8px 20px rgba(0,0,0,0.15); position: relative; overflow: hidden; }
.app-icon::after { content:''; position: absolute; top:0; left:0; right:0; bottom:0; background: linear-gradient(135deg, rgba(255,255,255,0.5) 0%, transparent 100%); pointer-events: none; }
.app-name { font-size: 13px; color: #475569; font-weight: 600; text-shadow: 0 1px 1px rgba(255,255,255,0.8); }
.setting-input { width: 100%; background: #f1f5f9; border: 1px solid #cbd5e1; padding: 10px; border-radius: 8px; font-size: 14px; outline: none; transition: border 0.2s; }
.setting-input:focus { border-color: #3b82f6; background: #fff; }
.setting-label { font-size: 14px; font-weight: bold; color: #334155; margin-bottom: 6px; display: block; }
.setting-section { background: white; border-radius: 12px; padding: 16px; margin-bottom: 12px; border: 1px solid #e2e8f0; }
.toggle-switch { width: 44px; height: 24px; background: #cbd5e1; border-radius: 99px; position: relative; transition: 0.3s; cursor: pointer; }
.toggle-switch.active { background: #3b82f6; }
.toggle-circle { width: 20px; height: 20px; background: white; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
.toggle-switch.active .toggle-circle { left: 22px; }
/* 聊天消息样式 */
.bubble-user { background-color: #95ec69; color: black; border-radius: 6px; padding: 10px; max-width: 100%; word-break: break-word; }
.bubble-ai { background-color: #ffffff; color: black; border-radius: 6px; padding: 10px; max-width: 100%; word-break: break-word; }
.bubble-redpacket { background: #fa9d3b; width: 220px; border-radius: 8px; overflow: hidden; cursor: pointer; }
.rp-content { padding: 15px; display: flex; align-items: center; gap: 10px; background: #fb5f48; color: white; }
.rp-icon { font-size: 24px; color: #fb5f48; background: #fedeb6; width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; }
.rp-footer { padding: 5px 10px; font-size: 10px; color: #666; background: white; }
/* 头像样式 - 修复灰边问题 */
.avatar-id-photo { background-color: transparent; padding: 0; object-fit: cover; width: 100%; height: 100%; }
/* 通用按钮 & 反馈 */
.save-btn { width: 100%; background: #3b82f6; color: white; font-weight: bold; padding: 12px; border-radius: 12px; margin-top: 10px; }
.api-group { background: white; border-radius: 16px; padding: 16px; border: 1px solid #e2e8f0; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
.api-input { width: 100%; background: #f1f5f9; border: 1px solid #e2e8f0; color: #333; border-radius: 10px; padding: 12px; margin-bottom: 12px; outline: none; }
.api-label { color: #64748b; font-size: 12px; margin-bottom: 6px; font-weight: 600; }
.diary-card { background: white; border-radius: 16px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid #e2e8f0; }
/* 全局 Toast 反馈 */
.toast-enter-active, .toast-leave-active { transition: all 0.3s ease; }
.toast-enter-from, .toast-leave-to { opacity: 0; transform: translateY(-20px) translateX(-50%); }
.toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; }
.toast-msg { background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 25px; font-size: 14px; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 8px; margin-bottom: 10px;}
</style>
</head>
<body>
<div id="app">
    <!-- 全局 Toast -->
    <div class="toast-container">
        <transition-group name="toast">
            <div v-for="t in toasts" :key="t.id" class="toast-msg">
                <i v-if="t.type==='success'" class="fas fa-check-circle text-green-400"></i>
                <i v-if="t.type==='error'" class="fas fa-times-circle text-red-400"></i>
                <i v-if="t.type==='info'" class="fas fa-info-circle text-blue-400"></i>
                {{ t.msg }}
            </div>
        </transition-group>
    </div>

    <!-- 隐藏文件输入 -->
    <input ref="globalChatInput" type="file" accept=".json" class="hidden-input" @change="importChatHistory">
    <input ref="globalCardInput" type="file" accept=".json,.png" class="hidden-input" @change="importCharacterCard">
    <input ref="globalCssInput" type="file" accept=".css,.txt" class="hidden-input" @change="importCssFile">
    <input ref="globalWorldInput" type="file" accept=".json,.txt" class="hidden-input" @change="importWorldFile">
    <input ref="globalStickerInput" type="file" accept="image/*" class="hidden-input" @change="addCustomSticker">
    <input ref="globalChatImgInput" type="file" accept="image/*" class="hidden-input" @change="sendImage">
    <input ref="globalDiaryImgInput" type="file" accept="image/*" class="hidden-input" @change="addDiaryImage">
    <input ref="roleAvatarInput" type="file" accept="image/*" class="hidden-input" @change="e=>updateChatAvatar(e, 'role')">
    <input ref="userAvatarInput" type="file" accept="image/*" class="hidden-input" @change="e=>updateChatAvatar(e, 'user')">
    <input ref="userPersonaInput" type="file" accept=".txt,.json" class="hidden-input" @change="importUserPersona">

    <!-- 顶部系统栏 -->
    <div v-if="currentApp === 'home' || (currentApp === 'chatApp' && currentChatId)" class="fixed top-0 w-full z-[100] flex justify-between px-6 py-2 text-xs font-bold text-slate-600" style="padding-top: max(5px, env(safe-area-inset-top));">
        <span>{{ currentTime }}</span>
        <div class="flex gap-2"><i class="fas fa-signal"></i><i class="fas fa-wifi"></i><i class="fas fa-battery-full"></i></div>
    </div>

    <!-- ================= 1. 桌面 ================= -->
    <div v-if="currentApp === 'home'" class="wallpaper-bg" style="display:flex; flex-direction:column; height:100%;">
        <div style="flex:1; display:flex; flex-direction:column; justify-content:space-between; padding-bottom:40px; padding-top:15vh;">
            <div class="text-center">
                <div class="text-7xl font-thin tracking-tighter text-slate-600">{{ currentTime }}</div>
                <div class="text-lg opacity-80 mt-2 font-medium text-slate-500">{{ currentDate }}</div>
                <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:2rem; width:100%; padding:0 2rem; margin-top:3rem;">
                    <div @click="openApp('chatApp')" style="display:flex; flex-direction:column; align-items:center; gap:8px;">
                        <div class="app-icon bg-gradient-to-b from-green-400 to-green-500"><i class="fas fa-comment-dots"></i></div>
                        <span class="app-name">Chat</span>
                    </div>
                    <div @click="openApp('role')" style="display:flex; flex-direction:column; align-items:center; gap:8px;">
                        <div class="app-icon bg-gradient-to-b from-blue-400 to-blue-500"><i class="fas fa-user-astronaut"></i></div>
                        <span class="app-name">角色</span>
                    </div>
                    <div @click="openApp('diary')" style="display:flex; flex-direction:column; align-items:center; gap:8px;">
                        <div class="app-icon bg-gradient-to-b from-amber-400 to-orange-400"><i class="fas fa-book-open"></i></div>
                        <span class="app-name">日记</span>
                    </div>
                </div>
            </div>
            <div class="dock-wrapper">
                <div class="dock-container">
                    <div @click="openApp('world')" style="display:flex; flex-direction:column; align-items:center;">
                        <div class="app-icon !w-14 !h-14 !text-2xl bg-gradient-to-b from-purple-400 to-purple-600"><i class="fas fa-globe-asia"></i></div>
                    </div>
                    <div @click="openApp('api')" style="display:flex; flex-direction:column; align-items:center;">
                        <div class="app-icon !w-14 !h-14 !text-2xl bg-gradient-to-b from-slate-500 to-slate-700"><i class="fas fa-sliders-h"></i></div>
                    </div>
                    <div @click="openApp('theme')" style="display:flex; flex-direction:column; align-items:center;">
                        <div class="app-icon !w-14 !h-14 !text-2xl bg-gradient-to-b from-pink-400 to-pink-600"><i class="fas fa-paint-brush"></i></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= 3. Chat App ================= -->
    <div v-else-if="currentApp === 'chatApp'" class="app-layout">
        <!-- 3.1 消息列表 (首页) -->
        <div v-if="activeTab === 0 && !currentChatId" class="flex flex-col h-full">
            <header class="app-header">
                <div @click="goHome" class="w-8 flex items-center"><i class="fas fa-chevron-left text-xl text-slate-600"></i></div>
                <div class="font-bold text-lg text-slate-800">Chat ({{store.activeChats.length}})</div>
                <div @click="showAddRoleModal=true" class="w-8 flex justify-end items-center"><i class="fas fa-plus text-xl text-blue-600"></i></div>
            </header>
            <main class="app-content">
                <div v-if="store.activeChats.length === 0" class="flex flex-col items-center justify-center h-64 text-gray-400">
                    <i class="far fa-comments text-4xl mb-2"></i><p>暂无会话</p>
                </div>
                <div v-for="chat in store.activeChats" :key="chat.id" @click="enterChat(chat.id)" class="flex items-center px-4 py-4 bg-white border-b border-gray-100 active:bg-gray-50">
                    <div class="w-12 h-12 rounded-lg bg-gray-200 mr-3 overflow-hidden shrink-0">
                        <img :src="chat.avatar || defaultDogAvatar" class="w-full h-full object-cover avatar-id-photo">
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-center mb-1">
                            <h3 class="font-bold text-base truncate text-slate-800">{{ chat.name }}</h3>
                            <span class="text-xs text-gray-400">{{ chat.lastTime }}</span>
                        </div>
                        <p class="text-sm text-gray-500 truncate">{{ chat.lastMsg || '点击开始聊天' }}</p>
                    </div>
                </div>
            </main>
        </div>

        <!-- 3.2 通讯录 (这里修改了：直接展示角色列表) -->
        <div v-if="activeTab === 1 && !currentChatId" class="flex flex-col h-full">
            <header class="app-header">
                <div @click="goHome" class="w-8 flex items-center"><i class="fas fa-chevron-left text-xl text-slate-600"></i></div>
                <div class="font-bold text-lg text-slate-800">通讯录</div>
                <div class="w-8"></div>
            </header>
            <main class="app-content p-4">
                <!-- 搜索框 (外观) -->
                <div class="bg-gray-100 p-2 rounded-lg text-gray-400 text-center mb-4 text-sm"><i class="fas fa-search"></i> 搜索</div>
                
                <div class="space-y-3">
                    <div class="text-xs font-bold text-gray-500 mb-2">我的角色</div>
                    
                    <!-- 如果没有角色 -->
                    <div v-if="store.roleList.length === 0" class="text-center py-10 text-gray-400 border-2 border-dashed border-gray-200 rounded-xl">
                        <p>暂无角色</p>
                        <p class="text-xs mt-1">请去“角色设置”添加</p>
                    </div>

                    <!-- 角色列表项 (点击直接聊天) -->
                    <div v-for="(role, index) in store.roleList" :key="index" 
                         @click="startChatFromContact(role)"
                         class="bg-white p-3 rounded-xl border border-gray-200 shadow-sm flex items-center gap-3 active:bg-gray-50">
                        <div class="w-10 h-10 bg-gray-200 rounded-lg shrink-0 overflow-hidden border border-gray-300">
                            <img :src="role.avatar || defaultDogAvatar" class="w-full h-full object-cover">
                        </div>
                        <div class="flex flex-col min-w-0">
                            <div class="font-bold text-slate-700 truncate">{{ role.name }}</div>
                            <div class="text-xs text-gray-400 truncate">{{ role.status || '点击发起聊天' }}</div>
                        </div>
                        <div class="ml-auto text-gray-300"><i class="fas fa-comment-dots"></i></div>
                    </div>
                </div>
            </main>
        </div>

        <!-- 3.2 动态 (占位) -->
        <div v-if="activeTab === 2 && !currentChatId" class="flex flex-col h-full items-center justify-center text-gray-400">
            <i class="fas fa-compass text-4xl mb-2"></i><p>动态暂未开发</p>
        </div>

        <!-- 3.3 我 (个人中心 - 修复头像样式与输入框大小) -->
        <div v-if="activeTab === 3 && !currentChatId" class="flex flex-col h-full bg-[#f8fafc]">
            <header class="app-header">
                <div @click="goHome" class="w-8 flex items-center"><i class="fas fa-chevron-left text-xl text-slate-600"></i></div>
                <div class="font-bold text-lg text-slate-800">个人中心</div>
                <div class="w-8"></div>
            </header>
            
            <main class="app-content p-4 space-y-4 pb-32 overflow-y-auto">
                <div class="setting-section flex flex-col items-center gap-3">
                    <div class="w-24 h-24 rounded-full bg-gray-200 overflow-hidden shadow-md relative group" @click="$refs.userAvatarInput.click()">
                        <img :src="store.user.avatar || defaultCatAvatar" class="avatar-id-photo">
                        <div class="absolute bottom-0 w-full bg-black/30 backdrop-blur-[2px] text-white text-xs text-center py-1">更换</div>
                    </div>
                    <input v-model="store.user.name" class="text-center font-bold text-xl bg-transparent border-b border-transparent focus:border-blue-500 outline-none py-2" placeholder="输入我的昵称">
                </div>

                <div class="setting-section">
                    <div class="flex justify-between items-center mb-2">
                        <label class="setting-label mb-0">我的人设 (全局)</label>
                        <button @click="$refs.userPersonaInput.click()" class="text-xs text-blue-500 font-bold"><i class="fas fa-file-import"></i> 导入</button>
                    </div>
                    <textarea v-model="store.user.prompt" rows="5" class="setting-input resize-none mb-3 text-base p-3" placeholder="在此输入你的全局人设..."></textarea>
                    
                    <!-- 用户人设预设 -->
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <div class="text-sm text-gray-500 mb-3 font-bold">人设预设</div>
                        <div class="flex flex-col gap-3">
                            <div class="relative">
                                <select v-model="presetSelect.user" @change="loadPreset('user')" class="setting-input appearance-none bg-white h-12 px-4 text-base w-full">
                                    <option :value="-1">-- 选择 / 新建 --</option>
                                    <option v-for="(p, idx) in store.presets.user" :value="idx">{{ p.name }}</option>
                                </select>
                                <div class="absolute right-4 top-3 pointer-events-none text-gray-500"><i class="fas fa-chevron-down"></i></div>
                            </div>
                            <div class="flex gap-2">
                                <input v-model="presetNameInput.user" class="setting-input h-12 px-4 text-base flex-1 mb-0" placeholder="预设名">
                                <button @click="savePreset('user')" class="bg-green-500 text-white rounded-lg px-4 h-12 font-bold shadow-sm whitespace-nowrap">保存</button>
                                <button v-if="presetSelect.user !== -1" @click="deletePreset('user')" class="bg-red-400 text-white rounded-lg px-4 h-12 font-bold shadow-sm"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="save-btn shadow-lg text-lg" @click="saveAllManual">保存修改</button>
            </main>
        </div>

        <!-- 聊天窗口 -->
        <div v-if="currentChatId" class="fixed inset-0 z-50 flex flex-col bg-[#ededed]">
            <header class="app-header bg-[#ededed]/95">
                <div @click="exitChat" class="flex items-center text-black cursor-pointer w-10 active:opacity-50"><i class="fas fa-chevron-left text-xl"></i></div>
                <div class="flex-1 flex flex-col pl-2 justify-center">
                    <div class="font-bold text-lg leading-tight">{{ currentChatData.name }}</div>
                    <div class="text-[10px] text-gray-500 leading-tight mt-0.5" :class="{'text-green-600': isLoading}">
                        {{ isLoading ? '对方正在输入中...' : '在线' }}
                    </div>
                </div>
                <div class="w-12 flex justify-end" @click="openChatSettings"><i class="fas fa-ellipsis-h text-black text-xl px-2 py-2"></i></div>
            </header>
            <main ref="chatBox" class="flex-1 overflow-y-auto p-4 space-y-4" style="padding-bottom: 120px;">
                <template v-for="(msg, i) in currentChatData.messages" :key="i">
                    <div v-if="msg.role !== 'system'" class="flex w-full" :class="msg.role === 'user' ? 'justify-end' : 'justify-start'">
                        <div v-if="msg.role === 'assistant'" class="w-10 h-10 rounded-md bg-white mr-2 shrink-0 overflow-hidden border border-gray-300">
                            <img :src="currentChatData.avatar || defaultDogAvatar" class="w-full h-full object-cover avatar-id-photo">
                        </div>
                        <div class="max-w-[85%]">
                            <div v-if="msg.type === 'redpacket'" class="bubble-redpacket shadow-sm">
                                <div class="rp-content">
                                    <div class="rp-icon"><i class="fas fa-yen-sign"></i></div>
                                    <div class="flex flex-col text-left">
                                        <span class="text-base font-medium text-white">{{ msg.content.split('\n')[0] }}</span>
                                        <span class="text-xs opacity-80">{{ msg.content.split('\n')[1] || '恭喜发财，大吉大利' }}</span>
                                    </div>
                                </div>
                                <div class="rp-footer">微信红包</div>
                            </div>
                            <div v-else-if="msg.image" class="rounded-lg overflow-hidden bg-white border border-gray-200 p-1 shadow-sm">
                                <img :src="msg.image" class="max-w-[200px] max-h-[200px] block" @click="previewImage(msg.image)">
                            </div>
                            <div v-else-if="msg.content && msg.content.trim()" class="text-base break-words shadow-sm leading-relaxed relative" :class="msg.role === 'user' ? 'bubble-user' : 'bubble-ai'">
                                <div class="whitespace-pre-wrap relative z-10">{{ msg.content }}</div>
                            </div>
                        </div>
                        <div v-if="msg.role === 'user'" class="w-10 h-10 rounded-md bg-gray-300 ml-2 shrink-0 overflow-hidden border border-gray-300">
                            <img :src="currentChatData.userAvatar || store.user.avatar || defaultCatAvatar" class="w-full h-full object-cover avatar-id-photo">
                        </div>
                    </div>
                </template>
            </main>
            <!-- Footer -->
            <footer class="bg-[#f7f7f7] border-t border-gray-300 shrink-0 pb-safe z-40 relative">
                <div class="px-3 pt-3 flex items-center gap-2">
                    <div class="flex-1 bg-white rounded-xl border border-gray-300 py-2 px-3 shadow-sm">
                        <textarea v-model="inputText" @keydown.enter.prevent="sendText" rows="1" class="w-full bg-transparent outline-none resize-none max-h-24 block text-base leading-5" placeholder="发消息..."></textarea>
                    </div>
                    <button @click="sendText" class="bg-[#3b82f6] text-white px-4 py-2 rounded-xl text-sm font-bold shadow-sm transition-transform active:scale-95">发送</button>
                </div>
                <div class="px-4 py-3 flex justify-between items-center text-gray-600 text-xl">
                    <button @click="triggerAiReply" class="hover:bg-gray-200 p-2 rounded-full transition text-blue-500" title="AI回复/继续"><i class="fas fa-magic"></i></button>
                    <button @click="showRedPacketModal=true" class="hover:bg-gray-200 p-2 rounded-full transition"><i class="fas fa-yen-sign"></i></button>
                    <button @click="$refs.globalChatImgInput.click()" class="hover:bg-gray-200 p-2 rounded-full transition"><i class="far fa-image"></i></button>
                    <button @click="showChatEmoji=!showChatEmoji" class="hover:bg-gray-200 p-2 rounded-full transition" :class="{'text-orange-500': showChatEmoji}"><i class="far fa-smile"></i></button>
                    <button @click="showToast('功能开发中', 'info')" class="hover:bg-gray-200 p-2 rounded-full transition"><i class="fas fa-plus-circle"></i></button>
                </div>
                <div v-if="showChatEmoji" class="h-56 bg-gray-100 border-t flex flex-col">
                    <div class="flex-1 overflow-y-auto p-2">
                        <div v-if="emojiTab === 'default'" class="grid grid-cols-8 gap-2">
                            <div v-for="e in defaultEmojis" @click="inputText+=e" class="text-center text-xl cursor-pointer hover:bg-white rounded py-1">{{e}}</div>
                        </div>
                        <div v-else-if="emojiTab === 'custom'">
                            <div v-if="store.customStickers.length > 0" class="grid grid-cols-4 gap-2">
                                <img v-for="s in store.customStickers" :src="s" class="w-16 h-16 object-cover rounded bg-white shadow-sm cursor-pointer" @click="sendSticker(s)">
                            </div>
                            <div v-else class="text-center text-gray-400 text-sm mt-8">暂无收藏，点击右下角 + 添加</div>
                        </div>
                    </div>
                    <div class="h-10 bg-white border-t flex items-center px-4 justify-between">
                        <div class="flex gap-4">
                            <button @click="emojiTab='default'" class="text-sm px-3 py-1 rounded-full font-bold" :class="emojiTab==='default'?'bg-blue-100 text-blue-600':'text-gray-400'">☺ 默认</button>
                            <button @click="emojiTab='custom'" class="text-sm px-3 py-1 rounded-full font-bold" :class="emojiTab==='custom'?'bg-red-100 text-red-600':'text-gray-400'">♥ 收藏</button>
                        </div>
                        <button @click="$refs.globalStickerInput.click()" class="text-xl text-gray-500 hover:text-blue-500 px-2"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
            </footer>
        </div>
        <!-- Tab Bar -->
        <div v-if="!currentChatId" class="tab-bar">
            <div class="tab-item" :class="{active: activeTab===0}" @click="activeTab=0"><i class="far fa-comment"></i><span>消息</span></div>
            <div class="tab-item" :class="{active: activeTab===1}" @click="activeTab=1"><i class="far fa-address-book"></i><span>通讯录</span></div>
            <div class="tab-item" :class="{active: activeTab===2}" @click="activeTab=2"><i class="far fa-compass"></i><span>动态</span></div>
            <div class="tab-item" :class="{active: activeTab===3}" @click="activeTab=3"><i class="far fa-user"></i><span>我</span></div>
        </div>
    </div>

    <!-- ================= 4. API & Config ================= -->
    <div v-else-if="currentApp === 'api'" class="app-layout">
        <header class="app-header">
            <button @click="goHome" class="text-blue-500 font-medium w-16 text-left"><i class="fas fa-chevron-left"></i> 返回</button>
            <h1 class="flex-1 text-center font-bold text-lg">API 设置</h1>
            <div class="w-16"></div>
        </header>
        <div class="app-content p-5 space-y-6">
            <div class="api-group">
                <div><div class="api-label">反代地址 (Proxy)</div><input v-model="store.api.baseUrl" class="api-input" placeholder="https://api.openai.com/v1"></div>
                <div><div class="api-label">密钥 (Key)</div><input v-model="store.api.key" type="password" class="api-input" placeholder="sk-..."></div>
                <div>
                    <div class="api-label">模型选择</div>
                    <div v-if="modelList.length > 0" class="relative">
                        <select v-model="store.api.model" class="api-input appearance-none"><option v-for="m in modelList" :value="m.id">{{m.id}}</option></select>
                        <div class="absolute right-3 top-3 text-gray-500 pointer-events-none"><i class="fas fa-chevron-down"></i></div>
                    </div>
                    <input v-else v-model="store.api.model" class="api-input">
                </div>
                <div class="mt-4 pt-4 border-t border-slate-200">
                    <div class="api-label flex justify-between"><span>API 预设配置</span></div>
                    <div class="flex flex-col gap-2 mt-2">
                        <div class="relative">
                            <select v-model="presetSelect.api" @change="loadPreset('api')" class="api-input appearance-none mb-0 bg-blue-50 border-blue-200 text-blue-800">
                                <option :value="-1">-- 选择预设 / 新建 --</option>
                                <option v-for="(p, idx) in store.presets.api" :value="idx">{{ p.name }}</option>
                            </select>
                            <div class="absolute right-3 top-3 text-blue-500 pointer-events-none"><i class="fas fa-chevron-down"></i></div>
                        </div>
                        <div class="flex gap-2">
                            <input v-model="presetNameInput.api" class="api-input mb-0 flex-1" placeholder="预设名称">
                            <div class="flex gap-1 shrink-0">
                                <button @click="savePreset('api')" class="bg-green-500 text-white rounded px-2 text-xs">保存</button>
                                <button v-if="presetSelect.api !== -1" @click="updatePreset('api')" class="bg-blue-500 text-white rounded px-2 text-xs">更新</button>
                                <button v-if="presetSelect.api !== -1" @click="deletePreset('api')" class="bg-red-400 text-white rounded px-2 text-xs"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
                <button @click="fetchModels" class="w-full bg-blue-50 text-blue-600 mt-4 py-3 rounded-lg font-bold border border-blue-200">{{ fetching ? '拉取中...' : '拉取模型列表' }}</button>
            </div>
            <button class="save-btn" @click="saveAllManual">保存配置</button>
        </div>
    </div>
<!-- ================= 2. Diary App (日记) ================= -->
    <div v-else-if="currentApp === 'diary'" class="app-layout bg-[#fffbf0]">
        <header class="app-header bg-[#fffbf0]/95 border-b border-[#e6e0d0]">
            <div @click="goHome" class="w-8 flex items-center"><i class="fas fa-chevron-left text-xl text-[#8b5e3c]"></i></div>
            <div class="flex bg-[#ede6d4] rounded-full p-1">
                <button @click="diaryTab='record'" class="px-4 py-1 rounded-full text-xs font-bold transition-all" :class="diaryTab==='record'?'bg-[#8b5e3c] text-white shadow-sm':'text-[#8b5e3c]'">记录</button>
                <button @click="diaryTab='calendar'" class="px-4 py-1 rounded-full text-xs font-bold transition-all" :class="diaryTab==='calendar'?'bg-[#8b5e3c] text-white shadow-sm':'text-[#8b5e3c]'">日历</button>
                <button @click="diaryTab='company'" class="px-4 py-1 rounded-full text-xs font-bold transition-all" :class="diaryTab==='company'?'bg-[#8b5e3c] text-white shadow-sm':'text-[#8b5e3c]'">陪伴</button>
            </div>
            <div class="w-8"></div>
        </header>

        <!-- 1. 记录板块 -->
        <div v-if="diaryTab === 'record'" class="app-content p-4 flex flex-col">
            <div class="bg-white rounded-2xl shadow-sm border border-[#e6e0d0] p-4 mb-4 flex-1 flex flex-col">
                <div class="text-xs text-gray-400 mb-2 flex justify-between">
                    <span>{{ currentDate }} {{ currentTime }}</span>
                    <i class="fas fa-cloud-sun text-orange-300"></i>
                </div>
                <textarea v-model="diaryInput" class="w-full flex-1 resize-none outline-none text-gray-700 leading-relaxed bg-transparent placeholder-gray-300" placeholder="记录今天发生的美好..."></textarea>
                <div v-if="diaryImages.length > 0" class="flex gap-2 mt-4 overflow-x-auto pb-2">
                    <div v-for="(img, idx) in diaryImages" :key="idx" class="w-20 h-20 shrink-0 rounded-lg overflow-hidden relative group">
                        <img :src="img" class="w-full h-full object-cover">
                        <button @click="diaryImages.splice(idx, 1)" class="absolute top-1 right-1 bg-black/50 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <div class="flex justify-between items-center mt-4 pt-3 border-t border-gray-100">
                    <div class="flex gap-4 text-[#8b5e3c] text-lg">
                        <button @click="$refs.globalDiaryImgInput.click()"><i class="far fa-image"></i></button>
                        <button @click="showToast('功能开发中...', 'info')"><i class="fas fa-microphone"></i></button>
                    </div>
                    <button @click="saveDiary" class="bg-[#8b5e3c] text-white px-6 py-2 rounded-full text-sm font-bold shadow-md active:scale-95 transition">保存日记</button>
                </div>
            </div>
            <div v-if="store.diaryList.length > 0" class="px-2">
                <div class="text-xs font-bold text-[#8b5e3c] mb-2 opacity-50">最近回顾</div>
                <div class="bg-white/60 p-4 rounded-xl border border-[#e6e0d0] text-sm text-gray-600 truncate">
                    {{ store.diaryList[0].content }}
                </div>
            </div>
        </div>

        <!-- 2. 日历板块 -->
        <div v-else-if="diaryTab === 'calendar'" class="app-content p-4 flex flex-col">
            <div class="flex justify-between items-center mb-6 px-4">
                <button @click="changeMonth(-1)" class="text-[#8b5e3c]"><i class="fas fa-chevron-left"></i></button>
                <div class="text-xl font-bold text-[#5c3d26]">{{ calendarDate.getFullYear() }}年 {{ calendarDate.getMonth() + 1 }}月</div>
                <button @click="changeMonth(1)" class="text-[#8b5e3c]"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="grid grid-cols-7 text-center mb-2 text-xs font-bold text-[#a0856c]">
                <span>日</span><span>一</span><span>二</span><span>三</span><span>四</span><span>五</span><span>六</span>
            </div>
            <div class="grid grid-cols-7 gap-2">
                <div v-for="(cell, i) in calendarGrid" :key="i" class="aspect-square rounded-lg overflow-hidden relative transition-transform active:scale-95" :class="cell.type==='empty' ? '' : 'bg-white shadow-sm border border-[#e6e0d0]'" @click="cell.entry ? showToast('查看: ' + cell.entry.content.substring(0,10)+'...') : null">
                    <template v-if="cell.type === 'day'">
                        <img v-if="cell.entry && cell.entry.images && cell.entry.images.length > 0" :src="cell.entry.images[0]" class="w-full h-full object-cover">
                        <div v-else-if="cell.entry" class="w-full h-full bg-[#f0e6d2] flex items-center justify-center"><i class="fas fa-pen-nib text-[#d4c5a9]"></i></div>
                        <div class="absolute top-1 left-0 w-full text-center text-[10px] font-bold" :class="(cell.entry && cell.entry.images && cell.entry.images.length > 0) ? 'text-white drop-shadow-md' : 'text-[#8b5e3c]'">{{ cell.day }}</div>
                    </template>
                </div>
            </div>
        </div>

        <!-- 3. 陪伴板块 -->
        <div v-else-if="diaryTab === 'company'" class="app-content p-6 space-y-6">
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-[#e6e0d0] relative overflow-hidden">
                <div class="absolute top-0 right-0 p-3 opacity-10"><i class="fas fa-hourglass-half text-6xl text-[#8b5e3c]"></i></div>
                <h3 class="text-[#8b5e3c] font-bold text-lg mb-2">时光胶囊</h3>
                <div v-if="randomMemory">
                    <p class="text-xs text-gray-400 mb-2">{{ new Date(randomMemory.id).toLocaleDateString() }}</p>
                    <p class="text-gray-600 text-sm leading-relaxed italic">"{{ randomMemory.content }}"</p>
                    <div v-if="randomMemory.images && randomMemory.images.length" class="mt-3 h-24 rounded-lg overflow-hidden w-full"><img :src="randomMemory.images[0]" class="w-full h-full object-cover"></div>
                </div>
                <div v-else class="text-gray-400 text-sm py-4 text-center">写下第一篇日记，开启时空之旅...</div>
            </div>
            <div class="bg-gradient-to-br from-[#8b5e3c] to-[#a07e5e] rounded-2xl p-6 shadow-md text-white">
                <div class="flex justify-between items-start mb-3"><h3 class="font-bold text-lg">AI 寄语</h3><i class="fas fa-robot text-white/50"></i></div>
                <div v-if="store.diaryList.some(d => d.aiReply)" class="text-sm leading-relaxed opacity-90">{{ store.diaryList.find(d => d.aiReply)?.aiReply }}</div>
                <div v-else class="text-sm opacity-70 text-center py-2">在“记录”页点击“AI分析”生成。</div>
                <button @click="store.diaryList.length > 0 ? triggerDiaryAI(store.diaryList[0]) : showToast('先写日记哦')" class="mt-4 w-full bg-white/20 hover:bg-white/30 py-2 rounded-lg text-xs font-bold transition">生成今日分析</button>
            </div>
        </div>
    </div>
    <!-- ================= 5. Role / World / Theme (其他 App) ================= -->
    <div v-else class="app-layout">
        <header class="app-header">
            <button @click="goHome" class="text-blue-500 font-medium w-16 text-left text-base"><i class="fas fa-chevron-left"></i> 返回</button>
            <h1 class="flex-1 text-center font-bold text-lg text-slate-800">{{ currentApp==='role'?'角色设置': currentApp==='world'?'世界书设置':'界面美化' }}</h1>
            <div class="w-16 flex justify-end items-center">
                <!-- 只有在 role 应用下显示 + 号 -->
                <button v-if="currentApp === 'role'" @click="showRoleOptionModal = true" class="text-blue-500 text-xl px-2">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </header>

        <!-- Role App (角色列表版) -->
        <div v-if="currentApp === 'role'" class="app-content p-4 relative">
            <!-- 1. 角色列表视图 -->
            <div class="space-y-3">
                <div class="text-xs font-bold text-gray-500 mb-2">AI 角色列表</div>
                
                <!-- 如果没有角色 -->
                <div v-if="store.roleList.length === 0" class="text-center py-10 text-gray-400 border-2 border-dashed border-gray-200 rounded-xl">
                    <p>暂无角色</p>
                    <p class="text-xs mt-1">点击右上角 + 号添加</p>
                </div>

                <!-- 角色列表项 -->
                <div v-for="(role, index) in store.roleList" :key="index" 
                     class="bg-white p-3 rounded-xl border border-gray-200 shadow-sm flex items-center justify-between">
                    <!-- 左侧：头像与名字 -->
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-10 h-10 bg-gray-200 rounded-lg shrink-0 overflow-hidden border border-gray-300">
                            <img :src="role.avatar || defaultDogAvatar" class="w-full h-full object-cover">
                        </div>
                        <div class="flex flex-col min-w-0">
                            <div class="font-bold text-slate-700 truncate">{{ role.name }}</div>
                            <div class="text-xs text-gray-400 truncate">{{ role.status || '无备注' }}</div>
                        </div>
                    </div>
                    
                    <!-- 右侧：铅笔图标 (点击打开编辑) -->
                    <button @click="openEditRole(role, index)" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-blue-500 transition">
                        <i class="fas fa-pencil-alt"></i>
                    </button>
                </div>
            </div>

            <!-- 2. 中间的 + 号选项弹窗 -->
            <div v-if="showRoleOptionModal" class="fixed inset-0 z-[50] flex items-center justify-center bg-black/50 backdrop-blur-sm" @click.self="showRoleOptionModal = false">
                <div class="bg-white w-64 rounded-xl shadow-2xl overflow-hidden flex flex-col animate-bounce-in">
                    <button class="p-4 border-b border-gray-100 text-blue-600 font-bold hover:bg-gray-50 active:bg-gray-100 transition" 
                        @click="$refs.globalCardInput.click(); showRoleOptionModal = false">
                        <i class="fas fa-file-import mr-2"></i> 导入角色 (png/json)
                    </button>
                    
                    <button class="p-4 border-b border-gray-100 text-blue-600 font-bold hover:bg-gray-50 active:bg-gray-100 transition"
                        @click="createNewRole(); showRoleOptionModal = false">
                        <i class="fas fa-plus-circle mr-2"></i> 添加角色
                    </button>
                    
                    <button class="p-4 text-gray-500 hover:bg-gray-50 active:bg-gray-100 transition" 
                        @click="showRoleOptionModal = false">
                        取消
                    </button>
                </div>
            </div>

            <!-- 3. 编辑/新建角色详细弹窗 -->
            <div v-if="showEditRoleModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-md p-6">
                <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[85vh]">
                    
                    <!-- 头部 -->
                    <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                        <span class="font-bold text-gray-700">{{ currentEditIndex===-1?'新建角色':'编辑角色' }}</span>
                        <button @click="showEditRoleModal=false"><i class="fas fa-times text-gray-400"></i></button>
                    </div>

                    <!-- 内容区：滚动 -->
                    <div class="p-4 overflow-y-auto space-y-4 flex-1">
                        <!-- 头像 -->
                        <div class="flex justify-center mb-2">
                            <div class="w-20 h-20 rounded-full bg-gray-200 border-4 border-white shadow-md relative overflow-hidden"
                                 @click="$refs.globalChatImgInput.click()">
                                <img :src="tempEditRole.avatar || defaultDogAvatar" class="w-full h-full object-cover">
                                <div class="absolute bottom-0 inset-x-0 bg-black/40 text-white text-[10px] text-center">头像</div>
                            </div>
                        </div>

                        <div>
                            <label class="text-xs font-bold text-gray-500 ml-1">角色名称</label>
                            <input v-model="tempEditRole.name" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mt-1 outline-none focus:border-blue-400" placeholder="例如：哆啦A梦">
                        </div>
                        
                        <div>
                            <label class="text-xs font-bold text-gray-500 ml-1">角色备注</label>
                            <input v-model="tempEditRole.status" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mt-1 outline-none focus:border-blue-400" placeholder="例如：万能机器人">
                        </div>

                        <div>
                            <label class="text-xs font-bold text-gray-500 ml-1">角色人设 (Prompt)</label>
                            <textarea v-model="tempEditRole.prompt" rows="5" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg mt-1 outline-none resize-none focus:border-blue-400 text-sm" placeholder="你是一只..."></textarea>
                        </div>
                    </div>

                    <!-- 底部按钮 -->
                    <div class="p-4 border-t bg-gray-50 flex flex-col gap-2">
                        <button @click="saveEditRole" class="w-full bg-blue-500 text-white py-3 rounded-xl font-bold shadow-md active:scale-95 transition">
                            保 存
                        </button>
                        <div class="flex gap-2">
                            <button @click="deleteEditRole" class="flex-1 text-red-500 bg-red-50 py-3 rounded-xl font-bold border border-red-100 hover:bg-red-100 transition">
                                删除
                            </button>
                            <button @click="showEditRoleModal=false" class="flex-1 text-gray-500 bg-white py-3 rounded-xl font-bold border border-gray-200 hover:bg-gray-50 transition">
                                取消
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- World App -->
        <div v-if="currentApp === 'world'" class="app-content p-4 flex flex-col">
            <div class="flex justify-between mb-2 px-1"><span class="font-bold text-slate-700">世界书</span><button @click="$refs.globalWorldInput.click()" class="text-blue-500 text-xs font-bold">导入</button></div>
            <textarea v-model="store.world.content" class="flex-1 w-full bg-white p-3 rounded-xl border border-slate-200 outline-none resize-none shadow-inner font-mono text-sm mb-4" placeholder="在此输入世界观..."></textarea>
            <div class="api-group p-3 mb-4">
                <div class="api-label">世界书预设</div>
                <div class="flex flex-col gap-2">
                    <select v-model="presetSelect.world" @change="loadPreset('world')" class="api-input appearance-none mb-0 bg-blue-50 border-blue-200 text-blue-800">
                        <option :value="-1">-- 选择预设 / 新建 --</option>
                        <option v-for="(p, idx) in store.presets.world" :value="idx">{{ p.name }}</option>
                    </select>
                    <div class="flex gap-2">
                        <input v-model="presetNameInput.world" class="api-input mb-0 flex-1" placeholder="预设名称">
                        <div class="flex gap-1 shrink-0">
                            <button @click="savePreset('world')" class="bg-green-500 text-white rounded px-2 text-xs">保存</button>
                            <button v-if="presetSelect.world !== -1" @click="deletePreset('world')" class="bg-red-400 text-white rounded px-2 text-xs"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>
            </div>
            <button class="save-btn" @click="saveAllManual">保存</button>
        </div>

        <!-- Theme App -->
        <div v-if="currentApp === 'theme'" class="app-content p-4 flex flex-col">
            <div class="flex justify-between mb-2 px-1"><span class="font-bold text-slate-700">自定义 CSS</span><button @click="$refs.globalCssInput.click()" class="text-blue-500 text-xs font-bold">导入</button></div>
            <textarea v-model="store.theme.css" class="flex-1 w-full bg-[#1e293b] text-green-400 p-3 rounded-xl border border-slate-700 outline-none resize-none font-mono text-xs mb-4 shadow-inner" placeholder="/* CSS */"></textarea>
            <div class="api-group p-3 mb-4">
                <div class="api-label">美化预设</div>
                <div class="flex flex-col gap-2">
                    <select v-model="presetSelect.theme" @change="loadPreset('theme')" class="api-input appearance-none mb-0 bg-blue-50 border-blue-200 text-blue-800">
                        <option :value="-1">-- 选择预设 / 新建 --</option>
                        <option v-for="(p, idx) in store.presets.theme" :value="idx">{{ p.name }}</option>
                    </select>
                    <div class="flex gap-2">
                        <input v-model="presetNameInput.theme" class="api-input mb-0 flex-1" placeholder="预设名称">
                        <div class="flex gap-1 shrink-0">
                            <button @click="savePreset('theme')" class="bg-green-500 text-white rounded px-2 text-xs">保存</button>
                            <button v-if="presetSelect.theme !== -1" @click="deletePreset('theme')" class="bg-red-400 text-white rounded px-2 text-xs"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>
            </div>
            <button class="save-btn" @click="saveAllManual">保存</button>
        </div>
    </div>

    <!-- Home Indicator -->
    <div class="home-indicator" @click="goHome"></div>

    <!-- Modals -->
    <!-- 添加角色 (旧的，现在保留作为备用或者可以整合) -->
    <div v-if="showAddRoleModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl overflow-hidden flex flex-col max-h-[80vh] shadow-2xl">
            <div class="p-4 border-b font-bold flex justify-between"><span>设定角色</span><button @click="showAddRoleModal=false"><i class="fas fa-times"></i></button></div>
            <div class="p-4 overflow-y-auto space-y-4">
                <button @click="$refs.globalCardInput.click()" class="w-full bg-blue-50 text-blue-600 py-3 rounded-xl border border-blue-100 font-bold">导入 JSON / PNG</button>
                <div class="space-y-1"><label class="text-xs text-gray-500 font-bold">角色名称</label><input v-model="tempRole.name" class="w-full border p-3 rounded-lg bg-gray-50"></div>
                <div class="space-y-1"><label class="text-xs text-gray-500 font-bold">人设 (Prompt)</label><textarea v-model="tempRole.prompt" rows="6" class="w-full border p-3 rounded-lg bg-gray-50 text-xs font-mono"></textarea></div>
            </div>
            <div class="p-4 border-t bg-gray-50"><button @click="addNewChat" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">开始聊天</button></div>
        </div>
    </div>

    <!-- 发红包 -->
    <div v-if="showRedPacketModal" class="fixed inset-0 bg-black/40 z-50 flex items-center justify-center p-4">
        <div class="bg-[#f0f0f0] w-64 rounded-lg overflow-hidden shadow-2xl">
            <div class="bg-[#d9594c] p-4 text-white text-center font-bold">发红包</div>
            <div class="p-4 space-y-3">
                <input v-model="rpAmount" type="number" class="w-full p-2 rounded border" placeholder="金额">
                <input v-model="rpNote" class="w-full p-2 rounded border" placeholder="添加备注">
                <button @click="sendRedPacket" class="w-full bg-[#d9594c] text-white py-2 rounded font-bold">塞钱进红包</button>
                <button @click="showRedPacketModal=false" class="w-full text-gray-500 py-1 text-sm">取消</button>
            </div>
        </div>
    </div>

    <!-- 聊天设置面板 -->
    <div v-if="showChatDetails" class="fixed inset-0 bg-black/30 z-[60]" @click="showChatDetails=false"></div>
    <div class="fixed inset-y-0 right-0 w-full md:w-[400px] bg-[#f8fafc] z-[70] shadow-2xl transform transition-transform duration-300 flex flex-col" :class="showChatDetails ? 'translate-x-0' : 'translate-x-full'">
        <div class="bg-white border-b px-4 py-3 flex justify-between items-center shrink-0 header-safe">
            <button @click="showChatDetails=false" class="text-gray-500 w-8"><i class="fas fa-chevron-right text-lg"></i></button>
            <div class="text-lg font-bold">聊天设置 <i class="fas fa-paw text-gray-400 text-sm"></i></div>
            <button @click="saveSettings" class="text-blue-500 text-2xl w-8 flex justify-end" title="保存设置"><i class="fas fa-paw"></i></button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-4">
            <div class="setting-section">
                <label class="setting-label">角色备注</label>
                <input v-model="editingChat.name" class="setting-input mb-4" placeholder="角色名称">
                <label class="setting-label">角色人设</label>
                <textarea v-model="editingChat.prompt" rows="4" class="setting-input resize-none" placeholder="输入角色 Prompt..."></textarea>
            </div>
            <div class="setting-section flex justify-around py-4">
                <div class="flex flex-col items-center gap-2">
                    <div class="w-16 h-16 rounded-full bg-gray-200 overflow-hidden border-2 border-blue-100"><img :src="editingChat.avatar || defaultDogAvatar" class="w-full h-full object-cover avatar-id-photo"></div>
                    <button @click="$refs.roleAvatarInput.click()" class="text-xs bg-white border border-gray-300 px-3 py-1 rounded-full shadow-sm">更换头像</button>
                </div>
                <div class="flex flex-col items-center gap-2">
                    <div class="w-16 h-16 rounded-full bg-gray-200 overflow-hidden border-2 border-green-100"><img :src="editingChat.userAvatar || store.user.avatar || defaultCatAvatar" class="w-full h-full object-cover avatar-id-photo"></div>
                    <button @click="$refs.userAvatarInput.click()" class="text-xs bg-white border border-gray-300 px-3 py-1 rounded-full shadow-sm">我的头像</button>
                </div>
            </div>
            <div class="setting-section">
                <label class="setting-label">我的人设</label>
                <textarea v-model="editingChat.userPersona" rows="3" class="setting-input resize-none" placeholder="我在本次对话中的设定..."></textarea>
            </div>
            <div class="setting-section space-y-4">
                <div class="flex items-center justify-between relative">
                    <span class="font-bold text-gray-700">挂载表情包</span>
                    <div class="relative">
                        <button @click="showStickerMenu = !showStickerMenu" class="text-2xl text-gray-500 hover:text-orange-500 transition"><i class="far fa-smile"></i></button>
                        <div v-if="showStickerMenu" class="absolute right-0 top-full mt-2 w-48 bg-white rounded-lg shadow-xl border border-gray-100 z-10 overflow-hidden flex flex-col text-sm">
                            <button class="px-4 py-3 text-left hover:bg-gray-50 border-b" @click="$refs.globalStickerInput.click()">上传图片 (相册)</button>
                            <button class="px-4 py-3 text-left hover:bg-red-50 text-red-500" @click="showStickerMenu=false">取消</button>
                        </div>
                    </div>
                </div>
                <div v-if="showStickerMenu" class="fixed inset-0 z-0" @click="showStickerMenu=false"></div>
                <div>
                    <span class="font-bold text-gray-700 block mb-2">挂载世界书</span>
                    <div class="relative">
                        <select v-model="editingChat.worldBookId" class="setting-input appearance-none bg-white">
                            <option :value="null">-- 无 (使用全局) --</option>
                            <option value="global">全局世界书</option>
                            <option v-for="(p, idx) in store.presets.world" :value="p.name">{{ p.name }} (预设)</option>
                        </select>
                        <div class="absolute right-3 top-3 pointer-events-none text-gray-500"><i class="fas fa-chevron-down"></i></div>
                    </div>
                </div>
            </div>
            <div class="setting-section space-y-4">
                <div>
                    <label class="setting-label flex justify-between">上下文记忆条数<span class="text-gray-400 font-normal">默认 50</span></label>
                    <input type="number" v-model.number="editingChat.memoryLimit" class="setting-input w-full" placeholder="50">
                </div>
                <div class="flex justify-between items-center"><span class="font-bold text-gray-700">聊天背景时间感知</span><div class="toggle-switch" :class="{active: editingChat.timeAware}" @click="editingChat.timeAware = !editingChat.timeAware"><div class="toggle-circle"></div></div></div>
                <div class="flex justify-between items-center"><span class="font-bold text-gray-700">自动总结</span><div class="toggle-switch" :class="{active: editingChat.autoSummary}" @click="editingChat.autoSummary = !editingChat.autoSummary"><div class="toggle-circle"></div></div></div>
                <div class="flex justify-between items-center pt-2">
                    <span class="font-bold text-gray-700">手动总结</span>
                    <button @click="triggerManualSummary" class="border border-gray-300 rounded-full px-3 py-1 text-xs text-gray-600 hover:bg-gray-100">立即执行</button>
                </div>
            </div>
            <div class="setting-section flex flex-col gap-2">
                <button class="text-left py-2 text-red-500 font-bold border-b border-gray-100" @click="clearHistory">清空聊天记录</button>
                <button class="text-left py-2 text-blue-500 font-bold border-b border-gray-100" @click="exportChatHistory">导出聊天记录</button>
                <button class="text-left py-2 text-blue-500 font-bold" @click="$refs.globalChatInput.click()">导入聊天记录</button>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp, reactive, ref, computed, onMounted, watch, nextTick } = Vue;
createApp({
    setup() {
        const currentApp = ref('home');
        const activeTab = ref(0);
        const currentChatId = ref(null);
        const showAddRoleModal = ref(false);
        const showRoleOptionModal = ref(false); // 新增
        const showChatDetails = ref(false);
        const showStickerMenu = ref(false);
        const showChatEmoji = ref(false);
        const emojiTab = ref('default'); 
        const editingChat = reactive({});

        // === 新增：日记 App 逻辑 ===
        const diaryTab = ref('record'); // 当前选中的 Tab: 'record', 'calendar', 'company'
        const calendarDate = ref(new Date()); // 日历当前显示的月份

        // 生成日历数据
        const calendarGrid = computed(() => {
            const year = calendarDate.value.getFullYear();
            const month = calendarDate.value.getMonth();
            const firstDay = new Date(year, month, 1).getDay(); // 当月第一天是周几
            const daysInMonth = new Date(year, month + 1, 0).getDate(); // 当月总天数
            
            const grid = [];
            // 填充前面的空白 (上个月)
            for(let i = 0; i < firstDay; i++) grid.push({ day: '', type: 'empty' });
            // 填充当月天数
            for(let i = 1; i <= daysInMonth; i++) {
                // 查找这一天是否有日记
                const dateStr = `${year}/${month+1}/${i}`; // 简单匹配格式，实际需根据存储格式调整
                // 利用日记的时间戳(id)来判断日期更准确
                const entry = store.diaryList.find(d => {
                    const dDate = new Date(d.id); 
                    return dDate.getFullYear() === year && dDate.getMonth() === month && dDate.getDate() === i;
                });
                grid.push({ day: i, type: 'day', entry: entry });
            }
            return grid;
        });

        // 切换月份
        const changeMonth = (delta) => {
            calendarDate.value = new Date(calendarDate.value.setMonth(calendarDate.value.getMonth() + delta));
        };

        // 陪伴板块：时光胶囊 (随机一条日记)
        const randomMemory = computed(() => {
            if (store.diaryList.length === 0) return null;
            // 简单搞个随机，实际可以使用更复杂的算法
            const idx = Math.floor(Math.random() * store.diaryList.length);
            return store.diaryList[idx];
        });
        // ==========================

        // === 新增：角色列表管理逻辑 ===
        const showEditRoleModal = ref(false);
        const tempEditRole = reactive({ name: '', status: '', prompt: '', avatar: '' });
        const currentEditIndex = ref(-1);

        const openEditRole = (role, index) => {
            currentEditIndex.value = index;
            Object.assign(tempEditRole, role || { name: '新角色', status: '', prompt: '', avatar: '' });
            showEditRoleModal.value = true;
        };

        const createNewRole = () => {
            openEditRole(null, -1);
        };

        const saveEditRole = () => {
            const newRoleData = { ...tempEditRole };
            if (currentEditIndex.value === -1) {
                store.roleList.push(newRoleData); 
            } else {
                store.roleList[currentEditIndex.value] = newRoleData; 
            }
            saveAll(); 
            showEditRoleModal.value = false;
            showToast('角色已保存');
        };

        const deleteEditRole = () => {
            if (currentEditIndex.value !== -1) {
                if(confirm('确定删除该角色吗？')) {
                    store.roleList.splice(currentEditIndex.value, 1);
                    saveAll();
                    showEditRoleModal.value = false;
                }
            } else {
                showEditRoleModal.value = false; 
            }
        };
        // ==============================

        // === 新增：通讯录点击发起聊天 ===
        const startChatFromContact = (role) => {
            if(!role || !role.name) return;
            const newChat = {
                id: Date.now(), 
                name: role.name, 
                avatar: role.avatar, 
                prompt: role.prompt, 
                messages: [], 
                lastMsg: '新会话', 
                lastTime: currentTime.value, 
                userAvatar: '', 
                userPersona: '', 
                memoryLimit: 50, 
                timeAware: false, 
                autoSummary: false, 
                worldBookId: null
            };
            store.activeChats.unshift(newChat);
            saveAll();
            showToast('已从通讯录发起聊天');
            activeTab.value = 0; // 切换回消息列表
            enterChat(newChat.id); // 直接进入聊天
        };

        // 红包相关
        const showRedPacketModal = ref(false);
        const rpAmount = ref('');
        const rpNote = ref('');

        const defaultDogAvatar = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M20,40 Q10,50 20,70 L25,80 Q30,90 50,90 Q70,90 75,80 L80,70 Q90,50 80,40 Q90,20 70,25 Q65,10 50,15 Q35,10 30,25 Q10,20 20,40 Z' fill='none' stroke='%23333' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'/%3E%3Ccircle cx='35' cy='45' r='3' fill='%23333'/%3E%3Ccircle cx='65' cy='45' r='3' fill='%23333'/%3E%3Cpath d='M45,60 Q50,65 55,60' fill='none' stroke='%23333' stroke-width='3' stroke-linecap='round'/%3E%3C/svg%3E";
        const defaultCatAvatar = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M25,35 Q15,15 40,25 Q50,20 60,25 Q85,15 75,35 Q90,50 80,75 Q70,90 50,90 Q30,90 20,75 Q10,50 25,35 Z' fill='none' stroke='%23333' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M30,50 Q30,50 40,50' fill='none' stroke='%23333' stroke-width='2'/%3E%3Cpath d='M60,50 Q70,50 70,50' fill='none' stroke='%23333' stroke-width='2'/%3E%3Cpath d='M45,65 Q50,70 55,65' fill='none' stroke='%23333' stroke-width='3' stroke-linecap='round'/%3E%3Cpath d='M15,55 L30,55 M15,65 L30,65 M85,55 L70,55 M85,65 L70,65' stroke='%23333' stroke-width='2'/%3E%3C/svg%3E";

        const toasts = ref([]);
        let toastId = 0;
        const showToast = (msg, type='success') => {
            const id = toastId++;
            toasts.value.push({id, msg, type});
            setTimeout(() => { toasts.value = toasts.value.filter(t => t.id !== id); }, 2000);
        };

        const now = ref(new Date());
        const chatBox = ref(null);
        const diaryInput = ref('');
        const diaryImages = ref([]);
        const showDiaryEmoji = ref(false);

        const store = reactive({
            activeChats: [], diaryList: [], 
            roleList: [], // 新增角色列表
            user: { name: '', prompt: '', avatar: '' },
            role: { name: 'AI', status: 'Online', prompt: 'You are helpful.', avatar: '' },
            world: { content: '' },
            api: { baseUrl: 'https://api.openai.com/v1', key: '', model: 'gpt-3.5-turbo' },
            theme: { css: '' },
            customStickers: [],
            presets: { api: [], world: [], theme: [], user: [] }
        });

        const tempRole = reactive({ name: '', prompt: '', avatar: '' });
        const modelList = ref([]);
        const fetching = ref(false);
        const inputText = ref('');
        const isLoading = ref(false);
        const defaultEmojis = ['😀','😂','🥰','😭','😡','👍','🙏','❤️','💔','👻','🔥','✨','🎁','👀','🐶','🐱'];

        setInterval(() => now.value = new Date(), 1000);
        const currentTime = computed(() => now.value.getHours().toString().padStart(2,'0') + ':' + now.value.getMinutes().toString().padStart(2,'0'));
        const currentDate = computed(() => (now.value.getMonth()+1)+'月 '+now.value.getDate()+'日');

        const openApp = (app) => currentApp.value = app;
        const goHome = () => { if(currentChatId.value){currentChatId.value=null; return;} currentApp.value = 'home'; };
        const currentChatData = computed(() => store.activeChats.find(c => c.id === currentChatId.value) || { messages:[] });

        watch(() => store.theme.css, (val) => {
            const el = document.getElementById('user-custom-css');
            if(!el) { const s = document.createElement('style'); s.id='user-custom-css'; document.head.appendChild(s); }
            document.getElementById('user-custom-css').innerText = val;
        });

        onMounted(() => {
            try {
                const s = localStorage.getItem('aios_ultra_store');
                if(s) {
                    const data = JSON.parse(s);
                    Object.assign(store, data);
                    if(!store.presets) store.presets = { api: [], world: [], theme: [], user: [] };
                    if(!store.presets.user) store.presets.user = [];
                    if(!store.user) store.user = { name:'', prompt:'', avatar:'' };
                    if(!store.roleList) store.roleList = []; // 确保有roleList
                }
            } catch(e) { console.error("Load Error", e); }
        });

        // 修复核心BUG：如果存储满了，捕获异常，不要让程序崩溃，确保后续清空输入框的代码能执行
        const saveAll = () => { 
            try {
                localStorage.setItem('aios_ultra_store', JSON.stringify(store)); 
            } catch (e) {
                showToast('存储空间已满！请清理数据', 'error');
                console.error('Storage quota exceeded', e);
            }
        };
        
        // 专门给手动点击保存按钮用的，一定提示成功
        const saveAllManual = () => {
            saveAll();
            showToast('保存成功');
        };

        const addNewChat = () => {
            if(!tempRole.name) return showToast('请输入角色名', 'error');
            const newChat = {
                id: Date.now(), name: tempRole.name, avatar: tempRole.avatar, prompt: tempRole.prompt, 
                messages: [], lastMsg: '新会话', lastTime: currentTime.value, userAvatar: '', userPersona: '', 
                memoryLimit: 50, timeAware: false, autoSummary: false, worldBookId: null
            };
            store.activeChats.unshift(newChat);
            showAddRoleModal.value = false; tempRole.name = ''; tempRole.prompt = ''; tempRole.avatar = ''; saveAll();
            showToast('会话已创建');
        };

        const enterChat = (id) => { currentChatId.value = id; nextTick(scrollToBottom); };
        const exitChat = () => currentChatId.value = null;
        
        const openChatSettings = () => { 
            Object.assign(editingChat, currentChatData.value);
            if(editingChat.memoryLimit === undefined) editingChat.memoryLimit = 50;
            showChatDetails.value = true; 
        };

        const saveSettings = () => {
            const chat = store.activeChats.find(c => c.id === currentChatId.value);
            if(chat) { Object.assign(chat, editingChat); saveAll(); showToast('设置已保存'); showChatDetails.value = false; }
        };

        const updateChatAvatar = (e, type) => {
            const f = e.target.files[0]; if(f) { const r = new FileReader(); r.onload = (ev) => { 
                if(type === 'role') editingChat.avatar = ev.target.result; 
                else if(type==='user' && currentChatId.value) editingChat.userAvatar = ev.target.result; 
                else store.user.avatar = ev.target.result; 
                saveAll(); 
            }; r.readAsDataURL(f); } e.target.value = '';
        };

        const clearHistory = () => { 
            if(confirm('确定清空?')) { 
                const chat = store.activeChats.find(c => c.id === currentChatId.value); 
                if(chat) chat.messages = [];
                editingChat.messages = []; saveAll(); showToast('记录已清空'); 
            } 
        };

        const exportChatHistory = () => {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(currentChatData.value));
            const node = document.createElement('a'); node.setAttribute("href", dataStr);
            node.setAttribute("download", currentChatData.value.name + "_history.json");
            document.body.appendChild(node); node.click(); node.remove();
        };

        const importChatHistory = (e) => {
            const f = e.target.files[0]; if(!f) return;
            const r = new FileReader(); r.onload = (ev) => { try { const data = JSON.parse(ev.target.result); 
                if(data.messages && Array.isArray(data.messages)) { 
                    const chat = store.activeChats.find(c => c.id === currentChatId.value); 
                    if(chat) chat.messages = data.messages;
                    saveAll(); showToast('导入成功'); 
                } else { showToast('格式错误', 'error'); } } catch(e) { showToast('文件错误', 'error'); } }; r.readAsText(f); e.target.value = '';
        };

        const importUserPersona = (e) => {
            const f = e.target.files[0]; if(!f) return;
            const r = new FileReader(); r.onload = (ev) => { try { const d = JSON.parse(ev.target.result); 
                store.user.prompt = d.prompt || d.content || d; showToast('人设导入成功'); 
            } catch(e){ store.user.prompt = ev.target.result; showToast('人设文本导入'); } saveAll(); }; r.readAsText(f); e.target.value = '';
        };

        const scrollToBottom = () => { if(chatBox.value) chatBox.value.scrollTop = chatBox.value.scrollHeight; };
        const previewImage = (src) => { const w=window.open('about:blank'); w.document.write(`<img src="${src}" style="width:100%">`); };
        
        const sendText = () => { 
            if(!inputText.value.trim()) return; 
            // 只有当不是因为崩溃导致的时候才发送
            pushMsg('user', inputText.value.trim()); 
            // 这行现在一定能执行到了，因为 pushMsg 里的 saveAll 做了防崩处理
            inputText.value = ''; 
        };
        
        const sendImage = (e) => { 
            const f = e.target.files[0]; if(f) { 
                const r=new FileReader(); r.onload=(ev)=>{ 
                    if(showEditRoleModal.value) { // 如果在编辑角色弹窗中，用于上传头像
                        tempEditRole.avatar = ev.target.result;
                    } else {
                        pushMsg('user', '', 'image', ev.target.result); 
                    }
                }; r.readAsDataURL(f); 
            } e.target.value=''; 
        };
        const sendSticker = (src) => { pushMsg('user', '', 'image', src); showChatEmoji.value = false; };
        const sendRedPacket = () => {
            if(!rpAmount.value) return showToast('请输入金额', 'error');
            const content = `${rpAmount.value}\n${rpNote.value || '恭喜发财，大吉大利'}`;
            pushMsg('user', content, 'redpacket');
            showRedPacketModal.value = false; rpAmount.value=''; rpNote.value='';
        };

        const triggerAiReply = async () => {
            const msgs = currentChatData.value.messages;
            const lastMsg = msgs[msgs.length - 1];
            if (lastMsg && lastMsg.role === 'user') { await generateReply(); } 
            else { pushMsg('system', '[System: Continue generating...]', 'hidden'); await generateReply(); }
        };

        const triggerManualSummary = async () => {
            if(!store.api.key) return showToast('Key?', 'error');
            pushMsg('system', '[System: Please generate a summary of our conversation so far.]', 'hidden');
            showToast('正在请求总结...', 'info'); await generateReply(); showToast('总结成功', 'success');
        };

        const pushMsg = (role, content, type, image) => {
            const msg = { role, content, type, image };
            currentChatData.value.messages.push(msg);
            if(role!=='system') { currentChatData.value.lastMsg = content || (type==='redpacket'?'[红包]':'[图片]'); currentChatData.value.lastTime = currentTime.value; }
            nextTick(scrollToBottom); saveAll();
        };

        const generateReply = async () => {
            if(!store.api.key) return showToast('请先配置 API Key', 'error');
            isLoading.value = true; nextTick(scrollToBottom);
            try {
                let s = "Instruction: Roleplay. Important: Reply in a natural, segmented way like a human chatting on WeChat. Use newlines to separate distinct thoughts or sentences. Keep it casual and strict to character.\n";
                if(currentChatData.value.timeAware) s += `[Current Time: ${currentTime.value}]\n`;
                
                let wbContent = store.world.content;
                if(currentChatData.value.worldBookId === 'global') wbContent = store.world.content;
                else if(currentChatData.value.worldBookId) { 
                    const preset = store.presets.world.find(p => p.name === currentChatData.value.worldBookId); 
                    if(preset) wbContent = preset.data; 
                }
                if(wbContent) s+=`[World Info]:\n${wbContent}\n`;
                
                if(currentChatData.value.prompt) s+=`[Character]: ${currentChatData.value.name}\n${currentChatData.value.prompt}\n`;
                const userP = currentChatData.value.userPersona || store.user.prompt;
                const userN = store.user.name || 'User';
                if(userP) s+=`[User]: ${userN}\n${userP}\n`;

                const limit = currentChatData.value.memoryLimit || 50;
                const history = currentChatData.value.messages.slice(-limit);
                const msgs = [{ role: 'system', content: s }, ...history.map(x => {
                    if(x.image) return { role: x.role, content: [{type:"text", text:" "}, {type:"image_url", image_url: {url:x.image}}] };
                    if(x.type === 'redpacket') return { role: x.role, content: `[User sent a Red Packet: ${x.content}]`};
                    return { role: x.role, content: x.content || " " };
                })];

                const res = await fetch(`${store.api.baseUrl.replace(/\/+$/,'')}/chat/completions`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${store.api.key}` }, 
                    body: JSON.stringify({ model: store.api.model, messages: msgs, max_tokens: 300, temperature: 0.8 })
                });
                const d = await res.json();
                if (d.error) throw new Error(d.error.message || 'API 错误');
                if (!d.choices || d.choices.length === 0) throw new Error('API 无响应');
                
                const rawContent = d.choices[0].message.content;
                let segments = rawContent.split('\n').filter(seg => seg.trim());
                for (let i = 0; i < segments.length; i++) {
                    const text = segments[i].trim();
                    if (!text) continue;
                    const delay = 500 + (text.length * 30);
                    await new Promise(r => setTimeout(r, delay));
                    pushMsg('assistant', text);
                }
            } catch(e) { pushMsg('assistant', `连接失败: ${e.message}`); } 
            finally { isLoading.value = false; nextTick(scrollToBottom); saveAll(); }
        };

        const addCustomSticker = (e) => { const f = e.target.files[0]; if(f) { const r=new FileReader(); r.onload=(ev)=>{ store.customStickers.push(ev.target.result); showToast('表情挂载成功'); }; r.readAsDataURL(f); } e.target.value=''; };

        const extractPngText = (buffer) => {
            const bytes = new Uint8Array(buffer); if (bytes[0] !== 137 || bytes[1] !== 80) return null;
            let offset = 8; const latin1Decoder = new TextDecoder('iso-8859-1');
            while (offset < bytes.length) {
                const len = (bytes[offset] << 24) | (bytes[offset+1] << 16) | (bytes[offset+2] << 8) | bytes[offset+3];
                const type = String.fromCharCode(bytes[offset+4], bytes[offset+5], bytes[offset+6], bytes[offset+7]);
                if (type === 'tEXt' || type === 'iTXt') {
                    const data = bytes.slice(offset + 8, offset + 8 + len);
                    let nullIdx = -1; for (let i = 0; i < data.length; i++) if (data[i] === 0) { nullIdx = i; break; }
                    if (nullIdx > -1) {
                        const kw = latin1Decoder.decode(data.slice(0, nullIdx));
                        if (kw.toLowerCase() === 'chara' || kw.toLowerCase() === 'character') {
                            try { return JSON.parse(decodeURIComponent(escape(atob(latin1Decoder.decode(data.slice(nullIdx + 1)))))); }
                            catch (e) { try { return JSON.parse(atob(latin1Decoder.decode(data.slice(nullIdx + 1)))); } catch(ee){} }
                        }
                    }
                } offset += 12 + len;
            } return null;
        };

        const importCharacterCard = (e) => {
            const f = e.target.files[0]; if (!f) return;
            if (f.name.endsWith('.json')) {
                const r = new FileReader();
                r.onload = (ev) => {
                    const json = JSON.parse(ev.target.result);
                    if (currentApp.value === 'role') {
                        fillTempRole(json);
                        store.roleList.push({ name: tempRole.name || '新角色', status: '', prompt: tempRole.prompt || '', avatar: tempRole.avatar || '' });
                        saveAll(); showToast('角色已导入列表');
                    } else { fillTempRole(json); }
                }; r.readAsText(f);
            } else if (f.name.endsWith('.png')) {
                const r = new FileReader();
                r.onload = (ev) => {
                    const d = extractPngText(ev.target.result);
                    const b = new Blob([ev.target.result], { type: 'image/png' });
                    const ur = new FileReader();
                    ur.onload = (ue) => {
                        const base64Img = ue.target.result;
                        if(currentApp.value === 'role') {
                            const newRole = {
                                name: (d && d.data && d.data.name) ? d.data.name : '新角色',
                                status: '',
                                prompt: (d && d.data && d.data.description) ? d.data.description : '',
                                avatar: base64Img
                            };
                            store.roleList.push(newRole); saveAll(); showToast('角色已导入列表');
                        } else {
                            tempRole.avatar = base64Img; if(d) fillTempRole(d);
                        }
                    }; ur.readAsDataURL(b);
                }; r.readAsArrayBuffer(f);
            } e.target.value = '';
        };

        const fillTempRole = (d) => { const data = d.data || d; tempRole.name = data.name || data.char_name || "New Char"; tempRole.prompt = [data.description, data.personality, data.scenario, data.mes_example].filter(Boolean).join('\n\n'); };
        
        const importCssFile = (e) => { const f = e.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = (ev) => { store.theme.css = ev.target.result; showToast('CSS 导入成功'); }; r.readAsText(f); e.target.value=''; };
        const importWorldFile = (e) => { const f = e.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = (ev) => { store.world.content = ev.target.result; showToast('世界书导入成功'); }; r.readAsText(f); e.target.value=''; };
        const handleImageUpload = (e, k) => { const f = e.target.files[0]; if(f) { const r=new FileReader(); r.onload=(ev)=>{ if(k==='user') store.user.avatar=ev.target.result; else if(k==='avatar') tempRole.avatar=ev.target.result; }; r.readAsDataURL(f); } };
        
        const fetchModels = async () => { 
            if(!store.api.key) return showToast('请输入 Key', 'error'); 
            fetching.value = true; modelList.value = []; 
            try { const r = await fetch(`${store.api.baseUrl.replace(/\/+$/,'')}/models`, { headers: { 'Authorization': `Bearer ${store.api.key}` } }); const d = await r.json(); if(Array.isArray(d.data)) modelList.value = d.data; } catch(e) { showToast('拉取失败: '+e.message, 'error'); } finally { fetching.value = false; } 
        };
        
        const addDiaryImage = (e) => { const f = e.target.files[0]; if(f) { const r=new FileReader(); r.onload=(ev)=>diaryImages.value.push(ev.target.result); r.readAsDataURL(f); } e.target.value=''; };
        
        const saveDiary = () => { 
            if(!diaryInput.value.trim() && diaryImages.value.length===0) return; 
            store.diaryList.unshift({ id: Date.now(), content: diaryInput.value, images: [...diaryImages.value], date: new Date().toLocaleString(), aiReply: '' }); 
            diaryInput.value = ''; diaryImages.value = []; saveAll(); showToast('日记已发布'); 
        };
        
        const deleteDiary = (id) => { if(confirm('删除?')) { store.diaryList = store.diaryList.filter(d=>d.id!==id); saveAll(); showToast('已删除'); } };
        
        const triggerDiaryAI = async (entry) => {
            if(!store.api.key) return showToast('Key?', 'error');
            try {
                const res = await fetch(`${store.api.baseUrl.replace(/\/+$/,'')}/chat/completions`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${store.api.key}` }, 
                    body: JSON.stringify({ model: store.api.model, messages: [{role:'user', content:`Analyze diary briefly:\n${entry.content}`}], max_tokens: 300 })
                });
                const d = await res.json(); entry.aiReply = d.choices[0].message.content; saveAll();
            } catch(e) { showToast(e.message, 'error'); }
        };

        const presetSelect = reactive({ api: -1, world: -1, theme: -1, user: -1 });
        const presetNameInput = reactive({ api: '', world: '', theme: '', user: '' });
        
        const savePreset = (type) => {
            const name = presetNameInput[type].trim(); if(!name) return showToast('请输入预设名称', 'error');
            let dataToSave;
            if(type==='api')dataToSave={...store.api};
            else if(type==='world')dataToSave=store.world.content;
            else if(type==='theme')dataToSave=store.theme.css;
            else if(type==='user')dataToSave=store.user.prompt;
            
            const existingIdx = store.presets[type].findIndex(p => p.name === name);
            if(existingIdx >= 0) { if(confirm('覆盖?')) store.presets[type][existingIdx].data = dataToSave; } 
            else { store.presets[type].push({ name, data: dataToSave }); }
            saveAll(); presetNameInput[type] = ''; showToast('预设已保存');
        };

        const updatePreset = (type) => { 
            const idx=presetSelect[type]; if(idx===-1)return; let d;
            if(type==='api')d={...store.api}; else if(type==='world')d=store.world.content; else if(type==='theme')d=store.theme.css; else if(type==='user')d=store.user.prompt;
            store.presets[type][idx].data=d; saveAll(); showToast('预设已更新');
        };

        const loadPreset = (type) => { 
            const idx=presetSelect[type]; if(idx===-1){presetNameInput[type]='';return;} const p=store.presets[type][idx]; presetNameInput[type]=p.name;
            if(type==='api')Object.assign(store.api,p.data); else if(type==='world')store.world.content=p.data; else if(type==='theme')store.theme.css=p.data; else if(type==='user')store.user.prompt=p.data;
            showToast('预设已加载');
        };

        const deletePreset = (type) => { 
            const idx=presetSelect[type]; if(idx===-1)return;
            if(confirm('Delete?')){store.presets[type].splice(idx,1); presetSelect[type]=-1; presetNameInput[type]=''; saveAll(); showToast('预设已删除');} 
        };

        return {
            currentApp, currentTime, currentDate, openApp, goHome, store, activeTab, currentChatId, 
            showAddRoleModal, showRoleOptionModal, showChatDetails, showStickerMenu, showChatEmoji, emojiTab, editingChat, diaryTab, calendarDate, calendarGrid, changeMonth, randomMemory,
            showEditRoleModal, tempEditRole, currentEditIndex, openEditRole, createNewRole, saveEditRole, deleteEditRole, 
            modelList, fetching, inputText, isLoading, chatBox, currentChatData, tempRole, defaultEmojis,
            diaryInput, diaryImages, showDiaryEmoji, toasts, showToast, showRedPacketModal, rpAmount, rpNote, sendRedPacket,
            addNewChat, enterChat, exitChat, saveAll, saveAllManual, sendText, sendImage, sendSticker, triggerAiReply, startChatFromContact,
            openChatSettings, saveSettings, updateChatAvatar, clearHistory, exportChatHistory, importChatHistory,
            previewImage, addCustomSticker, importCharacterCard, importCssFile, importWorldFile, handleImageUpload,
            fetchModels, addDiaryImage, saveDiary, deleteDiary, triggerDiaryAI, triggerManualSummary, importUserPersona,
            presetSelect, presetNameInput, savePreset, updatePreset, loadPreset, deletePreset, defaultDogAvatar, defaultCatAvatar
        };
    }
}).mount('#app');
</script>
</body>
</html>